# 
# Task: Strategic Planner (v2.2 with Metrics AND Librarian)
# Argument: $ARGUMENTS (feature_name / task_id)
#
# This is the v2.2 refactor of explore-plan.md.
# It includes Observability and the Agent Librarian fallback.
#

## Metrics Block (START)
# 1. Set START_TIME = current_timestamp
# 2. Set TASK_STATUS = "fail"
# 3. Set AGENTS_USED_LIST = []
# 4. Set TASK_ID = $ARGUMENTS
# 5. Set FEATURE_NAME = $ARGUMENTS
# 6. Set HUMAN_FEEDBACK_LOOPS = 0
# 7. Set ERROR_MSG = "null"

<user_request>
#$ARGUMENTS
</user_request>

At the end of this message, I will ask you to do something. Please follow the "Constitution, Team Selection, Plan, Advice, Update, Clarification and Iterate" workflow.

## Phase 1: Session Setup
Create `.claude/sessions/context_session_{FEATURE_NAME}.md` where the plan is going to be updated with all future iterations and feedback.

## Phase 2: Constitution
Read and parse the project's "Constitution" file: `CLAUDE.md`.
You MUST extract the following strategic sections:
- `[methodology].workflow`
- `[core_team]` list
- `[stack]` (for general context)

## Phase 3: Team Selection (REFACTORED v2.2 - Hybrid Model)

Your goal is to assemble the optimal "Planning Committee" for *this specific task*.

1.  **Start with the Core:**
    * Read the `[core_team]` list from `CLAUDE.md`.
    * `AGENT_LIST = [core_team]`

2.  **Analyze for Specialists:**
    * Analyze the `<user_request>` for keywords indicating a specialized need (e.g., "performance", "optimization", "database issue").
    * `REQUIRED_SPECIALISTS = ["@performance-profiler"]` (Example based on keywords)

3.  **Recruit Specialists (If Needed):**
    * `for specialist in $REQUIRED_SPECIALISTS:`
        * **(TRY): Check if agent exists:**
        * `if [ -f "/.claude/agents/$specialist.md" ]; then`
            * `AGENT_LIST.append($specialist)`
        * **(CATCH): Agent does not exist:**
        * `else`
            * print "Warning: Specialist `$specialist` not found in `/.claude/agents/`."
            * **Invoke Librarian:**
            * `claude @agent-librarian "scout: $specialist"`
            * print "Halting task. Please review the agent draft from @agent-librarian and re-run the plan."
            * `Set TASK_STATUS = "fail"`
            * `Set ERROR_MSG = "Missing specialist: $specialist. @agent-librarian invoked."`
            * **Go to Metrics Block (END) and EXIT**
        * `fi`

4.  **Announce the Team:** Announce the final selected team (Core Team + any Specialists).
5.  **Update Metrics Variable:** Store the final `AGENT_LIST` (names) in the `AGENTS_USED_LIST` variable.

## Phase 4: Plan
# (This phase is only reached if all agents exist)
Next, think hard and write up a detailed *initial* implementation plan.
- This plan MUST align with the `[methodology].workflow`.
- Write this initial plan to the `context_session.md`.

## Phase 5: Advice (REFACTORED for Context)
Use the sub-agents (from `AGENTS_USED_LIST`) *in parallel* to get knowledge and advice.
**CRITICAL:** You MUST provide each agent with both the `context_session.md` and the full `CLAUDE.md`.

## Phase 6: Update
Read all the advice and plans (e.g., `backend.md`, `frontend.md`, `security_plan.md`) generated by the agents.
Synthesize and consolidate all of them into one "master plan" in the `context_session.md` file.

## Phase 7: Clarification
Ask me (Daniel) questions about anything unclear, giving possible solutions in A) B) C) format.
(If I give feedback, increment `HUMAN_FEEDBACK_LOOPS`)
IMPORTANT: Wait for my answers before continuing.

## Phase 8: Iterate
Evaluate the plan and my feedback. Iterate over it until we have the final, approved plan.

---
**On Success:**
# Before running the Metrics Block (END), you must:
# 1. Set TASK_STATUS = "success"
---

## Metrics Block (END)
# This block MUST run at the very end, regardless of success or failure.
# 1. Set END_TIME = current_timestamp
# 2. Calculate DURATION = END_TIME - START_TIME
# 3. Construct METRICS_JSON string:
#    (Example: {"timestamp": "...", "task_id": "$TASK_ID", "command": "explore-plan", "status": "$TASK_STATUS", "duration_ms": $DURATION, "agents_used": $AGENTS_USED_LIST, "human_feedback_loops": $HUMAN_FEEDBACK_LOOPS, "error_message": "$ERROR_MSG"})
# 4. Call @metrics-logger with the JSON payload, SILENTLY.
#    (claude @metrics-logger "$METRICS_JSON" > /dev/null 2>&1)

## RULES
* **You MUST address me as "Daniel".**
* **The target of this session is to create the plan, DON'T implement it.**